# Ресурс "Хранилище" (storage)

Журнальные записи могут принадлежать системе в целом, какой-либо органиазции в отдельности через поле `owner`. Это
позволяет разграничить доступ к отдельным журнальным записям в системе по организациям.

Журнальные записи могут принадлежать пользователю через поле `usid`. Это позволяет разграничить доступ к отдельным
журнальным записям в системе по пользователям.

Журнальные записи могут ссылаться друг на друга через поле `parent`. Например, если сводки (bt=record) были вычленены из
какого то сообщения, то у них устанаваливается поле `parent` на родительское сообщение, чтобы всегда можно было найти по
сводкам исходное сообщение, из которого они были вычленены

Если указывается поле `key`, то оно должно жестко проверяться на формат `TTAAiiСССС`, где

* TT - кирилиические или латинские буквы в верхнем регистре
* AA - кирилиические или латинские буквы в верхнем регистре
* ii - кирилиические или латинские буквы в верхнем регистре и/или цифры
* СССС - кирилиические или латинские буквы в верхнем регистре

Если при записи сообщения/сводки в Хранилище указано поле `key` и одно или несколько полей `tt`, `aa`, `ii` и `cccc` то
должна выполняться проверка соотвествия полей `key` и полей `tt`, `aa`, `ii` и `cccc` в соотвествии.

В каждом вызове API проверяется возможность доступа к журнальной записи/записям на основнии информации о принадлежности
записи к той или иной организации через поле `allowed`

Журнальная запись может иметь идентифкатор топика `topic_hierarchy`, который описывает топик сообщения, к какой теме
относится сообщение в соотвествии с [**wis2-topic-hierarchy**](https://github.com/wmo-im/wis2-topic-hierarchy).

Так же журнальная запись может иметь идентифкатор топика канала MQTT `channel`, который описывает из какого канала
MQTT (из какого топика MQTT) получено сообщение.

Журнальная запись может иметь ссылку на идентификатор метаданных `urn`, которые описывают данные.

Этот идентификатор может как задаваться извне при вводе данных, так и формироваться внутри хранилища (в случае ввода
данных с телом метаданных)

Таким образом возможны следующие варианты и поведение:

1. В случае если данные вводятся с `urn`, но без тела метаданных `metadata.body`, то поле `urn` записывается как есть (
   ответственность пишущего)
2. В случае если данные вводятся без `urn`, код метода `/new` по полю `key` (если оно присутствует) запрашивает `urn` из
   микросервиса метаданных и, если метаданные существуют, из ответа инициализирует поля `urn`, `datapolicy` и  `source`.
3. В случае если данные вводятся без `urn` и если поле `key` не установлено, но задано тело метаданных `metadata.body`то
   код метода `/new` передает тело в мекросервис метаданных из ответа инициализирует поля `urn`, `datapolicy`
   и  `source`.

При использовании параметров типа `from` для поиска начиная с определённой записи, следует учитывать что точность
хранения времени в UUIDv1 может отличаться от точности хранения времени в ключе партицирования и поле в БД `rec_time`.
Поэтому в циклах, основанных на выборке по from, необходимы дополнительные проверки на записи, которые уже были
обработаны. На практике были замечены случаи погрешности в пределах 100 мкс.

Если сообщение метеорологическое то должны быть обязатльено заполнены атрибуты:

* attrs.format:  "HMS"/"WMO"
* attrs.shortheader:  "SASN32 ESWI 241550 RRA"

## 1. Получить журнальные записи

**Назначение:**   для получения списка журнальных записей в журнале хранилища. 

В ответе минимальное количество полей, только для построения таблицы последних сообщений журнала в интерфейсе пользователя. 
По умолчанию выборка производится в прошлое.

При запросе может быть указан список органиазций, которым принадлежат данные. Этот список сравнивается со спиоком
разрешенных организаций согласно правам доступа пользователя к организациям.

**Запрос:** `/api/v2/storage/list`

**Тип запроса:** GET

**Возможные параметры**:

| **имя поля**         | **тип**    | **описание**                                                                           |
|----------------------|------------|----------------------------------------------------------------------------------------|
| `owner`              | `[]uuid`   | список идентификаторов организаций, к которым принадлежат записи                       |
| `usid`               | `[]uuid`   | список идентификаторов пользователей, к которым принадлежат записи                     |
| `parent`             | `[]uuid`   | список идентификаторов радительских сообщений                                          |
| `index`              | `[]string` | список индексов станций с которыми связаны сообщения                                   |
| `tt`                 | `[]string` | список типов сообщений/сводок                                                          |
| `aa`                 | `[]string` | список регионов сообщений/сводок                                                       |
| `ii`                 | `[]string` | список листов сообщений/сводок                                                         |
| `cccc`               | `[]string` | список центров подачи сообщений сводок                                                 |
| `me`                 | `uuid`     | идентификатор пользователя который делает запрос или для которого делается запрос      |
| `from`               |            | уникальный идентификатор журнальной записи, с которой нужно продолжить выборку         |
|                      |            | (работает с небольшой точностью по времени; устаревший параметр, используйте `from_n`) |
| `from_n`             |            | сквозной номер журнальной записи, с которого нужно продолжить выборку                  |
| `count`              |            | количество выдаваемых записей. По умолчанию 100.                                       |
| `startAt`            | `int64`    | unixtime начало временного диапазона для поиска сообщений                              |
| `endAt`              | `int64`    | unixtime окончание временного диапазона для поиска сообщений                           |
| `startFmtAt`         | `int64`    | unixtime начало временного диапазона для поиска сообщений по метеорологическим срокам  |
| `endFmtAt`           | `int64`    | unixtime конец временного диапазона для поиска сообщений по метеорологическим срокам   |
| `flag`               | `string`   | список дополнительных параметров через запятую. Возможные варианты:                    |
| `-forward`           | `opt`      | поиск в будущее                                                                        |
| `-body`              | `opt`      | загружать в ответ тело журнальной записи или содержимое файла                          |
| `-priority1`         | `opt`      | -//-, но только для записей с приоритетом 1                                            |
| `-ignoremaxbodysize` | `opt`      | -//-, даже если превышен максимальный размер файла, для bodyType=message               |
| `-noreplicas`        | `opt`      | выдать запись только если она получена не с репликации                                 |
| `-filenotgone`       | `opt*      | выдать запись только если ассоциированный `file_link` не был удалён по TTL             |
| `name`               | `string`   | маска или регулярное выражение для сравнения с полем name, список оных через запятую   |
| `key`                | `string`   | маска или регулярное выражение для сравнения с полем key, список оных через запятую    |
| `topic_hierarchy`    | `string`   | список масок или регулярных выражений для сравнения с полем `topic_hierarchy`          |
| `urn`                | `string`   | маска или регулярное выражение для сравнения с полем `urn`, список оных через запятую  |
| `who`                | `string`   | список допустимых значений поля who, через запятую                                     |
| `not_who`            | `string`   | список недопустимых значений поля who, через запятую                                   |
| `max_size`           | `int`      | максимальный размер тела сообщения для выдачи **в байтах** (нестрогое сравнение)       |

Если параметры не указаны - выдавать последние 100 записей. Если параметр `startAt` не указан, считается "24 часа
назад от текущего момента". Если параметр `endAt` не указан, считается "сейчас".

Если указан параметр `from`, он налагает дополнительное условие на `endAt` (без флага `forward`), а подставляемая
в запрос дата `startAt` получается из `UUIDv1` журнальной записи, переданной во `from`. 
И напротив: параметр `from` может сочетаться с `flags=forward`, тогда выборка будет идти в будущее, начиная с определенной записи, 
т.е. `from` преобразуется в `startAt`, а `endAt` получается из `UUIDv1` журнальной записи.

| (нет флага и задан from):    | startAt  from |
|------------------------------|---------------|
| (forward флаг и задан from): | from  endAt   |

**Примеры:**

* `/api/v2/storage/list` - выборка последних 100 записей
* `/api/v2/storage/list?from=592bdd8c-6fa4-11e7-907b-a6006ad3dba0` выборка 100 записей, начиная с определенной, в
  прошлое
* `/api/v2/storage/list?from=592bdd8c-6fa4-11e7-907b-a6006ad3dba0&count=1000&flag=forward,body` - выборка 1000 записей,
  начиная с определенной, в будущее. Каждая запись содержит полный текст сообщения
* `/api/v2/storage/list?count=20&startAt=1500508800&endAt=1500900877` - отобразить 20 записей в период с 20.07.2017 по
  24.07.2017
* `/api/v2/storage/list?index=12345,UWUU` - выборка 1000 записей,
  начиная с определенной, в будущее. Каждая запись содержит полный текст сообщения

**Ответ:**

```json

{
  "meta": {},
  "response": {
    "jrecs": {
      "count": 4,
      "items": [
                {
                    "allowed": [
                        "00000000-0000-0000-0000-000000000000",
                        "eb905b4f-b4d3-11eb-acb6-f8b156aec8f1"
                    ],
                    "attrs": {
                        "from": "192.168.0.114:9876",
                        "link_name": "input ss2g 114 (718e95d1-b9dc-47c1-afb5-430eb47174e3) of SOCKET_SPECIAL",
                        "origin_file_name": "Z_SAT+CL,EURASIA,202511132100,g01,ST+IR+M9M11Hi8_C_RUPL_20251113212809.jpg",
                        "prid": "eb52a1be-84d5-11f0-a8c0-02420a00012d"
                    },
                    "bt": "file",
                    "datasets": [],
                    "file_path": "/var/communications/2025-13-11/411b80b3-dbfc-46eb-ad81-876d2d51c399",
                    "first": "...",
                    "hash": "8c70af84710486703978a8b8f6ea3358",
                    "history": null,
                    "jrid": "e2b7d078-c0d7-11f0-9994-02420a000199",
                    "metadata": {},
                    "n": 324102744,
                    "name": "Z_SAT+CL,EURASIA,202511132100,g01,ST+IR+M9M11Hi8_C_RUPL_20251113212809.jpg",
                    "owner": "",
                    "priority": 2,
                    "size": 439893,
                    "time": 1763069390,
                    "channel": "",
                    "topic_hierarchy": "",
                    "traceID": "dhixm1nslfwfpfp59dd5",
                    "type": "unknown",
                    "who": "718e95d1-b9dc-47c1-afb5-430eb47174e3"
                },
                {
                    "allowed": [
                        "00000000-0000-0000-0000-000000000000",
                        "eb905b4f-b4d3-11eb-acb6-f8b156aec8f1"
                    ],
                    "attrs": {
                        "crid": "1947a3b0-800d-11f0-a8c0-02420a00012d",
                        "descr": "0ca254a4-0c4b-4894-8f0b-861364df9000",
                        "email_headers": {
                            "From": [
                                "AMS30879@mecom.ru"
                            ],
                            "Subject": [
                                "RawDataXML"
                            ],
                            "To": [
                                "stream1@mecom.ru"
                            ]
                        },
                        "from": "10.0.0.2:15085",
                        "from_email": "AMS30879@mecom.ru",
                        "link_name": "smtp server 9004 (70dc5de2-bb3d-4085-ab93-22733aebf023) of SMTP_SRV_DOWN",
                        "prid": "6f132a4a-88c3-11f0-a8c0-02420a00012d",
                        "to_email": [
                            "stream1@mecom.ru"
                        ]
                    },
                    "bt": "message",
                    "datasets": [],
                    "first": "<?xml version=\"1.0\" encoding=\"windows-1251\"?>  <DataTransmit xmlns=\"http://lanit.ru\">  <Info>Generated data from meteo station</Info>  <DataSet>  <Data ID=\"Upper_Air\">  <Block ID=\"StationParam\">  <P N=\"Station_ID\">27500</P>  </Block>  <Block ID=\"METEO\"...",
                    "hash": "e14f3121343834e06ac22a5ad59df561",
                    "have_body": true,
                    "history": null,
                    "jrid": "ed2a0b14-c0d7-11f0-9994-02420a000199",
                    "metadata": {},
                    "n": 324102745,
                    "name": "RawDataXML",
                    "owner": "",
                    "priority": 2,
                    "size": 650,
                    "time": 1763069407,
                    "channel": "",
                    "topic_hierarchy": "",
                    "traceID": "zmy9dcyp7xblzuf9vz74",
                    "type": "XML",
                    "who": "70dc5de2-bb3d-4085-ab93-22733aebf023"
                },
                {
                    "allowed": [
                        "00000000-0000-0000-0000-000000000000",
                        "eb905b4f-b4d3-11eb-acb6-f8b156aec8f1"
                    ],
                    "attrs": {
                        "from": "192.168.0.114:9876",
                        "link_name": "input ss2g 114 (718e95d1-b9dc-47c1-afb5-430eb47174e3) of SOCKET_SPECIAL",
                        "origin_file_name": "QPPA98 RUMS 122100.bmp",
                        "prid": "eb52a1be-84d5-11f0-a8c0-02420a00012d"
                    },
                    "bt": "file",
                    "datasets": [],
                    "file_path": "/var/communications/2025-13-11/3446b657-4e6c-441b-8610-a524b1a43862",
                    "first": "BM...",
                    "hash": "36fd7b7351aa39d53fc01e6f3e7b8981",
                    "history": null,
                    "jrid": "ddab1417-c0d8-11f0-9994-02420a000199",
                    "metadata": {},
                    "n": 324102746,
                    "name": "QPPA98 RUMS 122100.bmp",
                    "owner": "",
                    "priority": 2,
                    "size": 607454,
                    "time": 1763069811,
                    "channel": "",
                    "topic_hierarchy": "",
                    "traceID": "ybn0unlm8i6h091ulotu",
                    "type": "unknown",
                    "who": "718e95d1-b9dc-47c1-afb5-430eb47174e3"
                },
                {
                    "allowed": [
                        "00000000-0000-0000-0000-000000000000",
                        "eb905b4f-b4d3-11eb-acb6-f8b156aec8f1"
                    ],
                    "attrs": {
                        "from": "10.0.0.2:40022",
                        "link_name": "input ss srv gis-moscow (90d77ba1-85f2-4dc9-8019-d4f1a00e4476) of SOCKET_SPECIAL",
                        "origin_file_name": "2025-11-14--23-22-30-AMS27602@mecom.ru.txt",
                        "prid": "22b95670-84d5-11f0-a8c0-02420a00012d"
                    },
                    "bt": "message",
                    "datasets": [],
                    "first": " <?xml version=\"1.0\" encoding=\"utf-8\"?> <message> <report TIME=\"14-11-2025T20:30:06+00:00\">  <station ID=\"27602\" LAT=\"55.064\" LON=\"37.311\" Z=\"186\"/>  <parameter VAR=\"TA\" Z=\"2M\">    <value PROC=\"AVE\" T=\"10M\">   6.0</value>  </parameter>  <parameter VAR=...",
                    "hash": "ab7d25eecea5ee3b0d10ebae8af6bcca",
                    "have_body": true,
                    "history": null,
                    "jrid": "ab42c477-c197-11f0-9994-02420a000199",
                    "metadata": {},
                    "n": 324152602,
                    "name": "2025-11-14--23-22-30-AMS27602@mecom.ru.txt",
                    "owner": "",
                    "priority": 2,
                    "size": 910,
                    "time": 1763151760,
                    "channel": "",
                    "topic_hierarchy": "",
                    "traceID": "inulc76cldqypehkgyyk",
                    "type": "XML",
                    "who": "90d77ba1-85f2-4dc9-8019-d4f1a00e4476"
                },
                {
                    "aa": "ER",
                    "allowed": [
                        "00000000-0000-0000-0000-000000000000",
                        "eb905b4f-b4d3-11eb-acb6-f8b156aec8f1"
                    ],
                    "attrs": {
                        "AA": "ER",
                        "BBB": "RRA",
                        "CCCC": "OMAE",
                        "DD": "14",
                        "HH": "20",
                        "II": "32",
                        "MM": "00",
                        "MT": "72000",
                        "TT": "SA",
                        "from": "192.168.0.109:7788",
                        "link_name": "input openmcep cli mitra5:7788 (05168138-87cd-4eee-9d8e-6d3b676454c0) of OPENMCEP",
                        "prid": "a440bf83-84d3-11f0-a8c0-02420a00012d"
                    },
                    "bt": "message",
                    "cccc": "OMAE",
                    "datasets": [],
                    "first": "SAER32 OMAE 142000 RRA   METAR OMSJ 142030Z 09004KT CAVOK 22/14 Q1017 NOSIG=",
                    "hash": "7d3bf0e6bc2e933b2b10a0614825703e",
                    "have_body": true,
                    "history": null,
                    "ii": "32",
                    "jrid": "aa6c1659-c197-11f0-9994-02420a000199",
                    "key": "SAER32OMAE",
                    "metadata": {},
                    "n": 324152601,
                    "name": "SAER32 OMAE 142000 RRA",
                    "owner": "",
                    "priority": 2,
                    "size": 76,
                    "time": 1763151759,
                    "channel": "",
                    "topic_hierarchy": "",
                    "traceID": "rdqcbte5e3kkbef9vyff",
                    "tt": "SA",
                    "type": "WMO",
                    "who": "05168138-87cd-4eee-9d8e-6d3b676454c0"
                }

      ]
    }
  }
}

```

**Возможные поля ответа:**

| **имя поля**        | **тип**       | **описание**                                                                          |
|---------------------|---------------|---------------------------------------------------------------------------------------|
| `jrid`              | `string`      | уникальный идентификатор журнальной записи                                            |
| `n`                 | `int64`       | сквозной номер журнальной записи                                                      |
| `name`              | `string`      | сокращенных заголовок/имя файла                                                       |
| `channel`           | `string`      | топик (канал) MQTT                                                                    |
| `topic_hierarchy`   | `string`      | ВМО топик данных                                                                      |
| `key`               | `string`      | ключ распределения                                                                    |
| `TT`                | `string[2]`   | тип данных                                                                            |
| `AA`                | `string[2]`   | регион данных                                                                         |
| `ii`                | `string[2]`   | номер листа данных                                                                    |
| `СССС`              | `string[4]`   | центр подачи                                                                          |
| `index`             | `string`      | индекс станции, с которой связано сообщение                                           |
| `metadata`          | `json`        | объект с метаданными связанными с этим данными                                        |
| `metadata.urn`      | `string[255]` | уникальный идентификатор метаданных                                                   |
| `metadata.source`   | `string`      | индекс источника данных и метаданных                                                  |
| `datasets`          | `[]uuid`      | список идентификаторов Наборов данных, к которым относятся данные                     |
| `allowed`           | `[]uuid`      | список идентификаторов организаций, которым доступны данные                           |
| `attrs`             | `json`        | объект с произвольными данными                                                        |
| `fmt`               | `unixtime`    | полный (с указанием даты) метеорологический срок                                      |
| `time`              | `unixtime`    | время записи в хранилище                                                              |
| `received_at`       | `unixtime`    | (устарело: только для репликации) время получения контента из канала связи            |
| `sync_time`         | `unixtime`    | (устарело: только для репликации) время синхронизации записи из другого хранилища     |
| `size`              | `int`         | размер в байтах                                                                       |
| `who`               | `uuid`        | уникальный идентификатор интерфейса, который произвел запись                          |
| `bt`                | `string`      | тип тела сообщения (message, file)                                                    |
| `priority`          | `int`         | приоритет журнальной записи                                                           |
| `double`            | `string`      | уникальный идентификатор дублирующей журнальной записи                                |
| `first`             | `string`      | первые 255 символов от тела сообщения                                                 |
| `owner`             | `uuid`        | идентификатор организации которой принадлежит контент                                 |
| `parent`            | `uuid`        | идентификатор родительского сообщения (того, с которым связано это сообщение)         |
| `usid`              | `uuid`        | идентификатор пользователя которому принадлежит контент                               |
| `datapolicy`        | `string[32]`  | правило доступа к данным                                                              |
| `distribution`      | `string[32]`  | масштаб распространения данных                                                        |
| `compid`            | `uuid`        | массив идентификаторов организаций которым доступны данные                            |
| `body`              | `string`      | содержимое сообщения или файла(для файлов base64) для сообщений меньше MAX_ENTER_SIZE |
| `reason`            | `string`      | причина по которой нет доступа к данным (поля `body` и `filelink` пустые)             |
| `replica`           | `bool`        | true если запись получена с репликации                                                |
| `file_gone`         | `bool`        | true если ассоциированный через `link_id` файл был удалён по TTL                      |
| `file_link.link_id` | `uuid`        | идентификатор внешнего файла (все сообщения вводятся и хранятся как файлы)            |

## 2. Получить журнальные записи по параметрам

**Назначение:**   для получения списка журнальных записей по их ID.

**Запрос:** `/api/v2/storage/list`

**Тип запроса:** POST

**Возможные параметры**:

| **имя поля**         | **тип**  | **описание**                                                                      |
|----------------------|----------|-----------------------------------------------------------------------------------|
| `usid`               | `uuid`   | идентификатор пользователя который делает запрос или для которого делается запрос |
| `flag`               | `string` | список дополнительных параметров через запятую. Возможные варианты:               |
| `-forward`           | *opt*    | поиск в будущее                                                                   |
| `-body`              | *opt*    | загружать в ответ тело журнальной записи или содержимое файла                     |
| `-priority1`         | *opt*    | -//-, но только для записей с приоритетом 1                                       |
| `-ignoremaxbodysize` | *opt*    | -//-, даже если превышен максимальный размер файла, для bodyType=message          |
| `-noreplicas`        | *opt*    | выдать запись только если она получена не с репликации                            |
| `-filenotgone`       | *opt*    | выдать запись только если ассоциированный `file_link` не был удалён по TTL        |

**Параметры в теле запроса:**

| **имя поля** | **тип**    | **описание**                              |
|--------------|------------|-------------------------------------------|
| `jrid`       | *[]uuid*   | массив идентификаторов журнальных записей |
| `hash`       | *[]string* | md5 хеш данных                            |

**Ответ:**
Как в запросе GET `/storage/list`

**Возможные поля ответа:**
Как в запросе GET `/storage/list`

## 3. Информация по указанной журнальной записи хранилища

**Назначение:**   для получения полной информации по идентификатору журнальной записи

**Запрос:** `/api/v2/storage/JREC_ID`

**Тип запроса:** GET

**Возможные параметры**:

| **имя поля** | **тип**  | **описание**                                                                      |
|--------------|----------|-----------------------------------------------------------------------------------|
| `usid`       | `uuid`   | идентификатор пользователя который делает запрос или для которого делается запрос |
| `flag`       | `string` | список параметров выдачи через запятую. Значения                                  |
| `-body`      |          | загружать в ответ тело журнальной записи или содержимое файла(base64)             |
| `-metadata`  | *opt*    | загружать в ответ тело метаданных                                                 |
| `-history`   |          | загружать в ответ всю историю записи                                              |

**Пример:**  
`/api/v2/storage/592bdd8c-6fa4-11e7-907b-a6006ad3dba0?flag=body,history,attachments`

- загрузит сообщение со всем содержимым (телом сообщения и телами вложений) и историей

**Ответ:**

```json

{
  "meta": {},
    "response": {
        "aa": "US",
        "allowed": [
            "00000000-0000-0000-0000-000000000000",
            "eb905b4f-b4d3-11eb-acb6-f8b156aec8f1"
        ],
        "attrs": {
            "AA": "US",
            "BBB": "",
            "CCCC": "KWBC",
            "DD": "14",
            "HH": "20",
            "II": "23",
            "MM": "26",
            "MT": "73560",
            "TT": "SA",
            "from": "192.168.0.109:7788",
            "link_name": "input openmcep cli mitra5:7788 (05168138-87cd-4eee-9d8e-6d3b676454c0) of OPENMCEP",
            "origin_file_name": "PHEI50 RUNW 131200.bmp",
            "prid": "eb52a1be-84d5-11f0-a8c0-02420a00012d"
            "crid": "1947a3b0-800d-11f0-a8c0-02420a00012d",
            "descr": "0ca254a4-0c4b-4894-8f0b-861364df9000",
                        "email_headers": {
                            "From": [
                                "AMS30879@mecom.ru"
                            ],
                            "Subject": [
                                "RawDataXML"
                            ],
                            "To": [
                                "stream1@mecom.ru"
                            ]
                        },
                        "from_email": "AMS30879@mecom.ru",
                        "to_email": [
                            "stream1@mecom.ru"
                        ]
        },
        "body": "U0FVUzIzIEtXQkMgMTQyMDI2DQ0KTUVUQVIgS1NSQiAxNDIwMTVaIEFVVE8gMjEwMDdHMTNLVCAyMDBWMjYwIDEwU00gQ0xSIDIyLzA1IEEzMDExDQ0KICAgICBSTUsgQU8yPQ0NCk1FVEFSIFRKUFMgMTQyMDE1WiBBVVRPIDE1MDA2S1QgMTBTTSBDTFIgMzAvMjQgQTI5ODggUk1LIEFPMj0=",
        "bt": "message",
        "cccc": "KWBC",
        "datasets": [],
        "file_path": "/var/communications/2025-13-11/724c548a-9026-4fa1-bfc4-bafea0e00a8e",
        "first": "SAUS23 KWBC 142026   METAR KSRB 142015Z AUTO 21007G13KT 200V260 10SM CLR 22/05 A3011        RMK AO2=   METAR TJPS 142015Z AUTO 15006KT 10SM CLR 30/24 A2988 RMK AO2=",
        "hash": "2b53d25548cbecd1e157c52d395b658f",
        "have_body": true,
        "history": [
            {
                "attrs": null,
                "cacheID": "jrs:772d1515-c198-11f0-9994-02420a000199",
                "event": "routed",
                "hrid": "32a1bea6-c788-4410-baf6-93bfd20555b6",
                "qid": "7d3dfb7f-241b-4661-959e-d562ad47e255",
                "qrid": "772d2872-c198-11f0-9994-02420a000199",
                "reason": "Распределена в 7d3dfb7f-241b-4661-959e-d562ad47e255 (ftp cli up local6)",
                "time": "2025-11-14T20:28:22.713128Z",
                "traceID": "zbh0ldkhlcl8hngdnk6x",
                "who": "05168138-87cd-4eee-9d8e-6d3b676454c0"
            },
            {
                "attrs": null,
                "cacheID": "jrs:772d1515-c198-11f0-9994-02420a000199",
                "event": "routed",
                "hrid": "331c5f2a-c62f-4e49-9b52-a6b393e648fc",
                "qid": "05003636-4a12-4df2-b4ce-3521a2e59a81",
                "qrid": "772d2905-c198-11f0-9994-02420a000199",
                "reason": "Распределена в 05003636-4a12-4df2-b4ce-3521a2e59a81 (queue for ftp srv up local)",
                "time": "2025-11-14T20:28:22.713274Z",
                "traceID": "zbh0ldkhlcl8hngdnk6x",
                "who": "05168138-87cd-4eee-9d8e-6d3b676454c0"
            },
            {
                "attrs": null,
                "cacheID": "jrs:772d1515-c198-11f0-9994-02420a000199",
                "event": "routed",
                "hrid": "6b4905dd-d002-4cce-a7bc-9527b31cdf84",
                "qid": "fe1c8d18-3577-11f0-ad06-02420a000181",
                "qrid": "772d2943-c198-11f0-9994-02420a000199",
                "reason": "Распределена в fe1c8d18-3577-11f0-ad06-02420a000181 (queue for ftp cli down local)",
                "time": "2025-11-14T20:28:22.7134Z",
                "traceID": "zbh0ldkhlcl8hngdnk6x",
                "who": "05168138-87cd-4eee-9d8e-6d3b676454c0"
            },
            {
                "attrs": null,
                "cacheID": "jrs:772d1515-c198-11f0-9994-02420a000199",
                "event": "routed",
                "hrid": "5cd8f5c1-bdcc-4c85-ac65-75bddf643191",
                "qid": "51dbc218-b6b6-4a42-bf8a-9c554abb8d66",
                "qrid": "772d2965-c198-11f0-9994-02420a000199",
                "reason": "Распределена в 51dbc218-b6b6-4a42-bf8a-9c554abb8d66 (queue for dir up seba test)",
                "time": "2025-11-14T20:28:22.713534Z",
                "traceID": "zbh0ldkhlcl8hngdnk6x",
                "who": "05168138-87cd-4eee-9d8e-6d3b676454c0"
            },
            {
                "attrs": null,
                "cacheID": "jrs:772d1515-c198-11f0-9994-02420a000199",
                "event": "routed",
                "hrid": "d63072ba-e577-41e9-83d6-00df63fa41bd",
                "reason": "Распределена в обработчик 2db5ac24-f8e2-11ef-bf6c-02420a000125",
                "time": "2025-11-14T20:28:22.713833Z",
                "traceID": "zbh0ldkhlcl8hngdnk6x",
                "who": "05168138-87cd-4eee-9d8e-6d3b676454c0"
            },
            {
                "attrs": null,
                "event": "created",
                "hrid": "2a3488e4-f370-4a92-93da-9765aeb5a185",
                "reason": "",
                "time": "2025-11-14T20:28:22.75433Z",
                "traceID": "zbh0ldkhlcl8hngdnk6x",
                "who": "05168138-87cd-4eee-9d8e-6d3b676454c0"
            },
            {
                "attrs": null,
                "event": "stored",
                "hrid": "7733a7e0-c198-11f0-b6e3-02420a00017c",
                "reason": "",
                "time": "2025-11-14T20:28:22.754916Z",
                "traceID": "zbh0ldkhlcl8hngdnk6x",
                "who": "05168138-87cd-4eee-9d8e-6d3b676454c0"
            }
        ],
        "ii": "23",
        "jrid": "772d1515-c198-11f0-9994-02420a000199",
        "key": "SAUS23KWBC",
        "metadata": {},
        "n": 324152923,
        "name": "SAUS23 KWBC 142026",
        "owner": "",
        "priority": 2,
        "size": 164,
        "time": 1763152102,
        "channel": "",
        "topic_hierarchy": "",
        "traceID": "zbh0ldkhlcl8hngdnk6x",
        "tt": "SA",
        "type": "WMO",
        "who": "05168138-87cd-4eee-9d8e-6d3b676454c0"
    }
}

``` 

**Возможные поля ответа:**

| **имя поля**        | **тип**       | **описание**                                                                       |
|---------------------|---------------|------------------------------------------------------------------------------------|
| `jrid`              | `string`      | уникальный идентификатор журнальной записи                                         |
| `n`                 | `int64`       | сквозной номер журнальной записи                                                   |
| `hash`              | `string`      | md5 хеш тела записи                                                                |
| `name`              | `string`      | сокращенных заголовок/имя файла                                                    |
| `metadata`          | `json`        | объект с метаданными связанными с этим данными                                     |
| `metadata.urn`      | `string[255]` | уникальный идентификатор метаданных                                                |
| `metadata.body`     | `base64`      | уникальный идентификатор метаданных                                                |
| `metadata.source`   | `string`      | индекс источника данных и метаданных                                               |
| `channel`           | `string`      | топик (канал) MQTT                                                                 |
| `topic_hierarchy`   | `string`      | ВМО топик данных                                                                   |
| `key`               | `string`      | ключ распределения                                                                 |
| `TT`                | `string[2]`   | тип данных                                                                         |
| `AA`                | `string[2]`   | регион данных                                                                      |
| `ii`                | `string[2]`   | номер листа данных                                                                 |
| `СССС`              | `string[4]`   | центр подачи                                                                       |
| `index`             | `string`      | индекс станции, с которой связано сообщение                                        |
| `fmt`               | `unixtime`    | полный (с указанием даты) метеорологический срок                                   |
| `time`              | `unixtime`    | время записи в хранилище                                                           |
| `received_at`       | `unixtime`    | (устарело: только для репликации) время получения контента из канала связи         |
| `sync_time`         | `unixtime`    | (устарело: только для репликации) время синхронизации записи из другого  хранилища |
| `owner`             | `uuid`        | идентификатор организации которой принадлежит контент                              |
| `parent`            | `uuid`        | идентификатор родительского сообщения (с которым связано это сообщение)            |
| `usid`              | `uuid`        | идентификатор пользователя которому принадлежит контент                            |
| `datapolicy`        | `string[32]`  | правило доступа к данным                                                           |
| `distribution`      | `string[32]`  | масштаб распространения данных                                                     |
| `compid`            | `uuid`        | массив идентификаторов организаций которым доступны данные                         |
| `size`              | `int`         | размер в байтах                                                                    |
| `bt`                | `string`      | тип тела сообщения (message, file)                                                 |
| `double`            | `string`      | уникальный идентификатор дублирующей журнальной записи                             |
| `priority`          | `int`         | приоритет журнальной записи                                                        |
| `who`               | `uuid`        | уникальный идентификатор интерфейса, который произвел запись                       |
| `attrs`             | `json`        | объект с произвольными данными                                                     |
| `history`           |               | список произошедших событий (описание полей см. в разделе 3.5)                     |
| `body`              |               | string текст журнальной записи или содержимое файла в base64                       |
| `reason`            | `string`      | причина по которой нет достуа к данным (поля `body` и `filelink` пустые )          |
| `file_link.link_id` | `uuid`        | идентификатор внешнего файла (все сообщения вводим как файлы и храним на диске )   |

## 4. Получение списка атрибутов журнальной записи

**Назначение:**   для получения списка атрибутов журнальной записи.

**Запрос:** `/api/v2/storage/JREC_ID/attrs`

**Тип запроса:** GET

**Пример:**   `/api/v2/storage /cb7a5670-6fa4-11e7-907b-a6006ad3dba0/attrs`

**Ответ:**

```json

{
  "meta": {},
    "response": {
        "attrs": {
            "from": "192.168.0.114:9876",
            "link_name": "input ss2g 114 (718e95d1-b9dc-47c1-afb5-430eb47174e3) of SOCKET_SPECIAL",
            "origin_file_name": "PHEI50 RUNW 131200.bmp",
            "prid": "eb52a1be-84d5-11f0-a8c0-02420a00012d"
        }
    }
}

```

## 5. Просмотр истории журнальный записи

**Назначение:**   для просмотра истории журнальной записи.

**Запрос:** `/api/v2/storage/JREC_ID/history`

**Тип запроса:** GET

**Пример:**   `/api/v2/storage/cb7a5670-6fa4-11e7-907b-a6006ad3dba0/history`

**Ответ:**

```json

{
  "meta": {},
  "response": {
    "history": {
      "count": 3,
      "items": [
            {
                "attrs": null,
                "cacheID": "jrs:772d1515-c198-11f0-9994-02420a000199",
                "event": "routed",
                "hrid": "d63072ba-e577-41e9-83d6-00df63fa41bd",
                "reason": "Распределена в обработчик 2db5ac24-f8e2-11ef-bf6c-02420a000125",
                "time": "2025-11-14T20:28:22.713833Z",
                "traceID": "zbh0ldkhlcl8hngdnk6x",
                "who": "05168138-87cd-4eee-9d8e-6d3b676454c0"
            },
            {
                "attrs": null,
                "event": "created",
                "hrid": "2a3488e4-f370-4a92-93da-9765aeb5a185",
                "reason": "",
                "time": "2025-11-14T20:28:22.75433Z",
                "traceID": "zbh0ldkhlcl8hngdnk6x",
                "who": "05168138-87cd-4eee-9d8e-6d3b676454c0"
            },
            {
                "attrs": null,
                "event": "stored",
                "hrid": "7733a7e0-c198-11f0-b6e3-02420a00017c",
                "reason": "",
                "time": "2025-11-14T20:28:22.754916Z",
                "traceID": "zbh0ldkhlcl8hngdnk6x",
                "who": "05168138-87cd-4eee-9d8e-6d3b676454c0"
            }
      ]
    }
  }
}

```

**Возможные поля ответа:**

| **имя поля** | **тип**  | **описание**                                        |
|--------------|----------|-----------------------------------------------------|
| `event`      | `string` | тип события произошедшего с записью                 |
| `time`       | `string` | время события в RFC3339Nano                         |
| `who`        | `string` | название интерфейса, который произвел запись        |
| `error`      | `string` | описание ошибки                                     |
| `qid`        | `uuid`   | идентификатор очереди                               |
| `qrid`       | `uuid`   | устаревшее: идентификатор записи очереди            |
| `reason`     | `string` | текстовый комментарий                               |
| `hrid`       | `uuid`   | ID записи истории                                   |
| `cacheID`    | `string` | ID содержимого записи в кэше (в KV-хранилище Redis) |
| `traceID`    | `string` | ID, соединяющий FAID, JR, HR итд                    |
| `attrs`      | `object` | произвольный объект                                 |

## 6. Добавление записи истории

**Назначение:**   для добавления лог записи журнальной записи.

**Запрос:** `/api/v2/storage/JREC_ID/history/new`

**Тип запроса:** POST

**Пример:**   `/api/v2/storage/cb7a5670-6fa4-11e7-907b-a6006ad3dba0/history/new`

**Возможные параметры:** нет

**Тело запроса:**

```json

{
  "history": {
                "attrs": [],
                "cacheID": "jrs:772d1515-c198-11f0-9994-02420a000199",
                "event": "routed",
                "hrid": "d63072ba-e577-41e9-83d6-00df63fa41bd",
                "reason": "Распределена в обработчик 2db5ac24-f8e2-11ef-bf6c-02420a000125",
                "time": "2025-11-14T20:28:22.713833Z",
                "traceID": "zbh0ldkhlcl8hngdnk6x",
                "who": "05168138-87cd-4eee-9d8e-6d3b676454c0"
            }
}

```

**Ответ:**

```json

{
  "meta": {},
  "response": {}
}

```

## 7. Массивное добавление записи истории

**Назначение:**   для добавления лог записи журнальной записи.

**Запрос:** `/api/v2/storage/history/bulknew`

**Тип запроса:** POST

**Пример:**   `/api/v2/storage/history/bulknew`

**Возможные параметры:** нет.

**Тело запроса:**

```json

{
  "history": [
            {
                "attrs": [],
                "cacheID": "jrs:772d1515-c198-11f0-9994-02420a000199",
                "event": "routed",
                "hrid": "d63072ba-e577-41e9-83d6-00df63fa41bd",
                "reason": "Распределена в обработчик 2db5ac24-f8e2-11ef-bf6c-02420a000125",
                "time": "2025-11-14T20:28:22.713833Z",
                "traceID": "zbh0ldkhlcl8hngdnk6x",
                "who": "05168138-87cd-4eee-9d8e-6d3b676454c0"
            },
            {
                "attrs": [],
                "event": "created",
                "hrid": "2a3488e4-f370-4a92-93da-9765aeb5a185",
                "reason": "",
                "time": "2025-11-14T20:28:22.75433Z",
                "traceID": "zbh0ldkhlcl8hngdnk6x",
                "who": "05168138-87cd-4eee-9d8e-6d3b676454c0"
            },
            {
                "attrs": [],
                "event": "stored",
                "hrid": "7733a7e0-c198-11f0-b6e3-02420a00017c",
                "reason": "",
                "time": "2025-11-14T20:28:22.754916Z",
                "traceID": "zbh0ldkhlcl8hngdnk6x",
                "who": "05168138-87cd-4eee-9d8e-6d3b676454c0"
            }
  ]
}

```

**Ответ:**

```json

{
  "meta": {},
  "response": {}
}

```

## 8. Добавить журнальную запись

**Назначение:**   для ввода журнальных записей в систему. Журнальная запись добавляется вместе с атрибутами.

Одним запросом можно добавить несколько записей. Если сообщение вводится в систему вместе с телом (меньше чем
MAX_ENTER_SIZE), то сервер сам расчитывает hash, first, size, ext и другие атрибуты, если они не указаны. Если сообщение
вводится в систему в виде ссылки на внешний файл – то эти параметры должны быть рассчитаны и переданы вызывающей
стороной.

Журнальные записи могут быть привязаны к списку органиазций, которым доступны записи в поле `allowed`.

Если контент вводится в виде ссылки на внешний файл, то надо проверять его готовность к вводу. Файл готовый ко вводу
имеет поля `size`=`written` > 0. Во всех других случаях должна генерироваться ошибка, что файл не заполнен и не готов к
использованию!

Каждая журнальная запись может иметь идентификатор связанных с ней метаданных в поле `urn`. Это поле заполняется
системой на основании алгоритма идентификации записи.

Возможны следующие варианты и поведение:

1. В случае если данные вводятся с `urn`, но без тела метаданных `metadata.body`, то поле `urn` записывается как есть (
   ответственность пишущего)
2. В случае если данные вводятся без `urn`, код метода `/new` по полю `key` (если оно присутствует) запрашивает `urn` из
   микросервиса метаданных и, если метаданные существуют, из ответа инициализирует поля `urn`, `datapolicy` и  `source`.
3. В случае если данные вводятся без `urn` и если поле `key` не установлено, но задано тело метаданных `metadata.body`то
   код метода `/new` передает тело в микросервис метаданных из ответа инициализирует поля `urn`, `datapolicy`
   и  `source`.

Далее:

* устанавливаем поле `urn` в соотвествующее значение идентификатора метаданных, которое получили из `metaspace`
* анализируем поле `datapolicy` в полученной информации от `metaspace`:
    * если поле `datapolicy`=`WMOEssential` - то значит это данные глобального кеша
    * если какое то другое значение, то значит это данные **НЕ** для глобального кеша

Для файлов глобального кеша должен использоваться домашний каталог глобального кеша.

Для файлов **НЕ** глобального кеша должен использовать каталог равный полю `index` из описания компании (см. вызов [**
/api/v1/companies/CMP_ID**](http://dev.modext.ru:8929/wis/doc-for-wis/-/blob/master/API/managements/companies.md#2-%D0%B8%D0%BD%D1%84%D0%BE%D1%80%D0%BC%D0%B0%D1%86%D0%B8%D1%8F-%D0%BF%D0%BE-%D1%83%D0%BA%D0%B0%D0%B7%D0%B0%D0%BD%D0%BD%D0%BE%D0%B9-%D0%BE%D1%80%D0%B3%D0%B0%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8) )

Таким образом, у кеша есть домашний каталог (например `GTS`), каталог по умолчанию (если не сработал ни один фильтр
групп кеша - поле `filter`) и каталоги групп кеша.

Точно такая же конфигурация каталогов и у данных **НЕ** глобального кеша, но базовый каталог = `index` организации

К моменту обновления метаданных, они должны существовать и если отсутствуют и возникает ошибка при попытке их обновить,
то записываем сообщение об ошибке в лог и игнорируем ошибку.

Если данные с таким хешем `hash` существуют, то данные повторно не вводятся, за исключением метода `/renew` (см. ниже)

**Запрос:** `/api/v2/storage/new`

**Тип запроса:** POST

**Тело запроса:**

```json

{
  "jrecs": [
{
                    "allowed": [
                        "00000000-0000-0000-0000-000000000000",
                        "eb905b4f-b4d3-11eb-acb6-f8b156aec8f1"
                    ],
                    "attrs": {
                        "from": "192.168.0.114:9876",
                        "link_name": "input ss2g 114 (718e95d1-b9dc-47c1-afb5-430eb47174e3) of SOCKET_SPECIAL",
                        "origin_file_name": "Z_SAT+CL,EURASIA,202511132100,g01,ST+IR+M9M11Hi8_C_RUPL_20251113212809.jpg",
                        "prid": "eb52a1be-84d5-11f0-a8c0-02420a00012d"
                    },
                    "bt": "file",
                    "datasets": [],
                    "file_path": "/var/communications/2025-13-11/411b80b3-dbfc-46eb-ad81-876d2d51c399",
                    "first": "...",
                    "hash": "8c70af84710486703978a8b8f6ea3358",
                    "history": null,
                    "jrid": "e2b7d078-c0d7-11f0-9994-02420a000199",
                    "metadata": {},
                    "n": 324102744,
                    "name": "Z_SAT+CL,EURASIA,202511132100,g01,ST+IR+M9M11Hi8_C_RUPL_20251113212809.jpg",
                    "owner": "",
                    "priority": 2,
                    "size": 439893,
                    "time": 1763069390,
                    "channel": "",
                    "topic_hierarchy": "",
                    "traceID": "dhixm1nslfwfpfp59dd5",
                    "type": "unknown",
                    "who": "718e95d1-b9dc-47c1-afb5-430eb47174e3"
                },
                {
                    "allowed": [
                        "00000000-0000-0000-0000-000000000000",
                        "eb905b4f-b4d3-11eb-acb6-f8b156aec8f1"
                    ],
                    "attrs": {
                        "crid": "1947a3b0-800d-11f0-a8c0-02420a00012d",
                        "descr": "0ca254a4-0c4b-4894-8f0b-861364df9000",
                        "email_headers": {
                            "From": [
                                "AMS30879@mecom.ru"
                            ],
                            "Subject": [
                                "RawDataXML"
                            ],
                            "To": [
                                "stream1@mecom.ru"
                            ]
                        },
                        "from": "10.0.0.2:15085",
                        "from_email": "AMS30879@mecom.ru",
                        "link_name": "smtp server 9004 (70dc5de2-bb3d-4085-ab93-22733aebf023) of SMTP_SRV_DOWN",
                        "prid": "6f132a4a-88c3-11f0-a8c0-02420a00012d",
                        "to_email": [
                            "stream1@mecom.ru"
                        ]
                    },
                    "bt": "message",
                    "datasets": [],
                    "first": "<?xml version=\"1.0\" encoding=\"windows-1251\"?>  <DataTransmit xmlns=\"http://lanit.ru\">  <Info>Generated data from meteo station</Info>  <DataSet>  <Data ID=\"Upper_Air\">  <Block ID=\"StationParam\">  <P N=\"Station_ID\">27500</P>  </Block>  <Block ID=\"METEO\"...",
                    "hash": "e14f3121343834e06ac22a5ad59df561",
                    "have_body": true,
                    "history": [
        {
          "attrs": {},
          "cacheID": "7bca258e-24f3-11f0-9477-02420a000194",
          "event": "received",
          "hrid": "7bca25c1-24f3-11f0-9477-02420a000194",
          "reason": "received message traceID=sb5yj58lvzq82ymlptce from 192.168.0.109:7785",
          "time": "2025-04-29T12:14:22.098375Z",
          "traceID": "sb5yj58lvzq82ymlptce",
          "who": "datacomm/input openmcep cli mitra5:7785 (0f914724-698a-481b-8f86-f832b12ff1d7) of OPENMCEP"
        },
        {
          "attrs": {},
          "cacheID": "7bca258e-24f3-11f0-9477-02420a000194",
          "event": "sent_to_fta",
          "hrid": "7bca4a57-24f3-11f0-9477-02420a000194",
          "reason": "sent to FTA",
          "time": "2025-04-29T12:14:22.099312Z",
          "traceID": "sb5yj58lvzq82ymlptce",
          "who": "datacomm/input openmcep cli mitra5:7785 (0f914724-698a-481b-8f86-f832b12ff1d7) of OPENMCEP"
        }                      
                    ],
                    "jrid": "ed2a0b14-c0d7-11f0-9994-02420a000199",
                    "metadata": {},
                    "n": 324102745,
                    "name": "RawDataXML",
                    "owner": "",
                    "priority": 2,
                    "size": 650,
                    "time": 1763069407,
                    "channel": "",
                    "topic_hierarchy": "",
                    "traceID": "zmy9dcyp7xblzuf9vz74",
                    "type": "XML",
                    "who": "70dc5de2-bb3d-4085-ab93-22733aebf023"
                },
                {
                    "allowed": [
                        "00000000-0000-0000-0000-000000000000",
                        "eb905b4f-b4d3-11eb-acb6-f8b156aec8f1"
                    ],
                    "attrs": {
                        "from": "192.168.0.114:9876",
                        "link_name": "input ss2g 114 (718e95d1-b9dc-47c1-afb5-430eb47174e3) of SOCKET_SPECIAL",
                        "origin_file_name": "QPPA98 RUMS 122100.bmp",
                        "prid": "eb52a1be-84d5-11f0-a8c0-02420a00012d"
                    },
                    "bt": "file",
                    "datasets": [],
                    "file_path": "/var/communications/2025-13-11/3446b657-4e6c-441b-8610-a524b1a43862",
                    "first": "BM...",
                    "hash": "36fd7b7351aa39d53fc01e6f3e7b8981",
                    "history": [
        {
          "attrs": {},
          "cacheID": "7bca258e-24f3-11f0-9477-02420a000194",
          "event": "received",
          "hrid": "7bca25c1-24f3-11f0-9477-02420a000194",
          "reason": "received message traceID=sb5yj58lvzq82ymlptce from 192.168.0.109:7785",
          "time": "2025-04-29T12:14:22.098375Z",
          "traceID": "sb5yj58lvzq82ymlptce",
          "who": "datacomm/input openmcep cli mitra5:7785 (0f914724-698a-481b-8f86-f832b12ff1d7) of OPENMCEP"
        },
        {
          "attrs": {},
          "cacheID": "7bca258e-24f3-11f0-9477-02420a000194",
          "event": "sent_to_fta",
          "hrid": "7bca4a57-24f3-11f0-9477-02420a000194",
          "reason": "sent to FTA",
          "time": "2025-04-29T12:14:22.099312Z",
          "traceID": "sb5yj58lvzq82ymlptce",
          "who": "datacomm/input openmcep cli mitra5:7785 (0f914724-698a-481b-8f86-f832b12ff1d7) of OPENMCEP"
        }                      
                    ],
                    "jrid": "ddab1417-c0d8-11f0-9994-02420a000199",
                    "metadata": {},
                    "n": 324102746,
                    "name": "QPPA98 RUMS 122100.bmp",
                    "owner": "",
                    "priority": 2,
                    "size": 607454,
                    "time": 1763069811,
                    "channel": "",
                    "topic_hierarchy": "",
                    "traceID": "ybn0unlm8i6h091ulotu",
                    "type": "unknown",
                    "who": "718e95d1-b9dc-47c1-afb5-430eb47174e3"
                }
  ]
}

```

**Обязательные поля**:

| **имя поля** | **тип**  | **описание**                                                 |
|--------------|----------|--------------------------------------------------------------|
| `name`       | `string` | сокращенный заголовок/имя файла                              |
| `bt`         | `string` | тип тела сообщения (message, file, report)                   |
| `who`        | `uuid`   | уникальный идентификатор интерфейса, который произвел запись |

**Необязательные поля запроса**:

| **имя поля**        | **тип**       | **описание**                                                                                        |
|---------------------|---------------|-----------------------------------------------------------------------------------------------------|
| `channel`           | `string`      | топик (канал) MQTT                                                                                  |
| `topic_hierarchy`   | `string`      | ВМО топик данных                                                                                    |
| `key `              | `string`      | ключ распределения                                                                                  |
| `fmt`               | `unixtime`    | полный (с указанием даты) метеорологический срок                                                    |
| `index`             | `string`      | индекс станции, с которой связано сообщение                                                         |
| `tt`                | `string[2]`   | тип сообщения/сводки                                                                                |
| `aa`                | `string[2]`   | метеорологический регион сообщения/сводки                                                           |
| `ii`                | `string[2]`   | лист сообщения/сводки                                                                               |
| `cccc`              | `string[4]`   | центр подачи сообщения/сводки                                                                       |
| `hash`              | `string`      | md5 хеш тела записи                                                                                 |
| `metadata`          | `json`        | объект с метаданными связанными с этим данными                                                      |
| `metadata.urn`      | `string[255]` | уникальный идентификатор метаданных                                                                 |
| `metadata.body`     | `base64`      | уникальный идентификатор метаданных                                                                 |
| `metadata.source`   | `string`      | индекс источника данных и метаданных                                                                |
| `attrs`             |               | список атрибутов (сссс, сокр заголовок, bbb)                                                        |
| `priority`          | `int`         | приоритет журнальной записи (1-4)                                                                   |
| `file_link.link_id` | `uuid`        | идентификатор внешнего файла, если сообщение в сообщение вводилось как файл (больше MAX_ENTER_SIZE) |
| `owner`             | `uuid`        | идентификатор организации-владельца                                                                 |
| `parent`            | `uuid`        | идентификатор родительского сообщения (с которым связано это сообщение)                             |
| `usid`              | `uuid`        | идентификатор пользователя которому принадлежит контент                                             |
| `allowed`           | `[]uuid`      | список идентификаторов организаций, которым доступны данные                                         |
| `body`              | `string`      | текст журнальной записи или содержимое файла в base64                                               |

**Обязательные атрибуты для метео сообщения:**

Если не указывается поле `fmt` то оно должно устанавливаться в `NULL`

Если добавляемое сообщение метеорологического типа, передающая сторона должна задать атрибуты (поле attr) со следующими
вложенными полями

| **имя поля**  | **тип**  | **описание**                     |
|---------------|----------|----------------------------------|
| `format`      | `string` | тип метео-сообщения: HMS или WMO |
| `shortheader` | `string` | сокращенный заголовок            |
| `cccc`        | `string` | центр подачи                     |

**Ответ:**

```json

{
  "meta": {},
  "response": {
    "jrecs": [
      "042f5218-71f8-11e7-8cf7-a6006ad3dba0",
      "042f5556-71f8-11e7-8cf7-a6006ad3dba0"
    ]
  }
}

```

**Поля ответа:**

| **имя поля** | **тип** | **описание**                                |
|--------------|---------|---------------------------------------------|
| `jrecs`      | `array` | массив идентификаторов вставленных записей. |

## 9. Повторый ввод данных

**Назначение:**   Ввести данные повторно.

При вызове эмулируется ввод данных (дублируются журнальные записи, но `hash` остается те же самым). Это приводит к тому,
что данные снова будут переданы получателям.

**Запрос:** `/api/v2/storage/renew`

**Тип запроса:** POST

**Тело запроса:**

```json

{
  "timing": {
    "from": 346246264,
    "to": 346246264
  },
  "jrid": [
    "xxxx-xxxx-xxxx-xxxxx",
    "yyyy-yyyy-yyyy-yyyyy"
  ]
}

```

**Поля тела:**

| **имя поля**  | **тип** | **описание**                                                  |
|---------------|---------|---------------------------------------------------------------|
| `timing`      | json    | время с которого и по которое нужно ввести данные повтоно     |
| `timing.from` | json    | время с которого нужно ввести данные повторно                 |
| `timing.to`   | json    | время по которое нужно ввести данные (если не указано то now) |
| `jrid`        |         | список журнальных записей, над которыми производится действие |

## 10. Поиск записей истории

**Назначение:**   для поиска записей истории

**Запрос:** `/api/v2/storage/history/list`

**Тип запроса:** POST

**Тело запроса:**

```json
{
  "traceid": [
    "6bj0oy69rjmvyyf2tpmv"
  ]
}
```

**Возможные поля запроса:**

| **имя поля** | **тип**          | **описание**                                                  |
|--------------|------------------|---------------------------------------------------------------|
| `startAt`    | `unix timestamp` | начало временной рамки поиска                                 |
| `endAt`      | `unix timestamp` | окончание временной рамки поиска                              |
| `traceid`    | `[]string`       | массив traceID (соединяет JR, HR, FAID итд)                   |
| `jrid`       | `[]uuid`         | массив JRID                                                   |
| `cacheid`    | `[]string`       | массив cacheID (ID соотв-х записей в KV-хранилище кэша Redis) |

Если значение `startAt` или `endAt` не заданы, берутся из `jrid`, пользуясь тем что это `UUIDv1` (содержит timestamp). 
Если и это не задано, берутся в интервал `-7 суток` от текущего момента. Это необходимо для того что бы запрос 
работал с приемлемым быстродействием, т.к. таблица с HR'ами партицируется по дате-времени. 

**Ответ:**

Такая же структура ответа как у запроса `/storage/<jrid>/history`.

```json
{
  "meta": {
    "code": 200,
    "rid": "9c14afb2-25bb-11f0-bb7e-02420a000125",
    "time": "1267.852"
  },
  "response": {
    "history": {
      "count": 7,
      "items": [
        {
          "attrs": {},
          "cacheID": "7bca258e-24f3-11f0-9477-02420a000194",
          "event": "received",
          "hrid": "7bca25c1-24f3-11f0-9477-02420a000194",
          "reason": "received message traceID=sb5yj58lvzq82ymlptce from 192.168.0.109:7785",
          "time": "2025-04-29T12:14:22.098375Z",
          "traceID": "sb5yj58lvzq82ymlptce",
          "who": "datacomm/input openmcep cli mitra5:7785 (0f914724-698a-481b-8f86-f832b12ff1d7) of OPENMCEP"
        },
        {
          "attrs": {},
          "cacheID": "7bca258e-24f3-11f0-9477-02420a000194",
          "event": "sent_to_fta",
          "hrid": "7bca4a57-24f3-11f0-9477-02420a000194",
          "reason": "sent to FTA",
          "time": "2025-04-29T12:14:22.099312Z",
          "traceID": "sb5yj58lvzq82ymlptce",
          "who": "datacomm/input openmcep cli mitra5:7785 (0f914724-698a-481b-8f86-f832b12ff1d7) of OPENMCEP"
        },
        {
          "attrs": {},
          "cacheID": "jrs:7bcf62cf-24f3-11f0-80d0-02420a0001cb",
          "event": "routed",
          "hrid": "b1ebe28a-f714-428b-8411-d356495bb0ef",
          "qid": "bf1d7915-0eef-4dfb-aa7f-57c975b02710",
          "qrid": "7bcf75d8-24f3-11f0-80d0-02420a0001cb",
          "reason": "Распределена в bf1d7915-0eef-4dfb-aa7f-57c975b02710 (1)",
          "time": "2025-04-29T12:14:22.133481Z",
          "traceID": "sb5yj58lvzq82ymlptce",
          "who": "0f914724-698a-481b-8f86-f832b12ff1d7"
        },
        {
          "attrs": {},
          "cacheID": "jrs:7bcf62cf-24f3-11f0-80d0-02420a0001cb",
          "event": "routed",
          "hrid": "1c131fec-cb0d-4781-a9e0-9dc97dd89690",
          "reason": "Распределена в обработчик 2db5ac24-f8e2-11ef-bf6c-02420a000125",
          "time": "2025-04-29T12:14:22.133882Z",
          "traceID": "sb5yj58lvzq82ymlptce",
          "who": "0f914724-698a-481b-8f86-f832b12ff1d7"
        },
        {
          "attrs": {},
          "cacheID": "jrs:7bcf62cf-24f3-11f0-80d0-02420a0001cb",
          "event": "routed",
          "hrid": "c1753914-eda4-4be7-9d5b-60e2f4272cdc",
          "reason": "Распределена в обработчик 1998f465-f8e2-11ef-bf6c-02420a000125",
          "time": "2025-04-29T12:14:22.134237Z",
          "traceID": "sb5yj58lvzq82ymlptce",
          "who": "0f914724-698a-481b-8f86-f832b12ff1d7"
        },
        {
          "attrs": {},
          "event": "created",
          "hrid": "6ad1dd46-1a9d-4325-846c-39133dc87429",
          "reason": "",
          "time": "2025-04-29T12:14:22.262496Z",
          "traceID": "sb5yj58lvzq82ymlptce",
          "who": "0f914724-698a-481b-8f86-f832b12ff1d7"
        },
        {
          "attrs": {},
          "event": "stored",
          "hrid": "7be34d97-24f3-11f0-bc0f-02420a000196",
          "reason": "",
          "time": "2025-04-29T12:14:22.263235Z",
          "traceID": "sb5yj58lvzq82ymlptce",
          "who": "0f914724-698a-481b-8f86-f832b12ff1d7"
        }
      ]
    }
  }
}
```

**Возможные поля ответа:**

| **имя поля** | **тип**  | **описание**                                        |
|--------------|----------|-----------------------------------------------------|
| `event`      | `string` | тип события произошедшего с записью                 |
| `time`       | `string` | время события в RFC3339Nano                         |
| `who`        | `string` | название интерфейса, который произвел запись        |
| `error`      | `string` | описание ошибки                                     |
| `qid`        | `uuid`   | идентификатор очереди                               |
| `qrid`       | `uuid`   | устаревшее: идентификатор записи очереди            |
| `reason`     | `string` | текстовый комментарий                               |
| `hrid`       | `uuid`   | ID записи истории                                   |
| `cacheID`    | `string` | ID содержимого записи в кэше (в KV-хранилище Redis) |
| `traceID`    | `string` | ID, соединяющий FAID, JR, HR итд                    |
| `attrs`      | `object` | произвольный объект                                 |