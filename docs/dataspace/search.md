# Ресурс "Поиск" (search)

Ресурс "Поиск" предназначен для управления Поисками в Хранилище системы

Каждый Поиск привязывается к организации или системе, а так же к пользователю который запустил Поиск. 

Если вызывающий пользователь не привязан к организации, то Поиск привязывается к системе (`cpmpid = 00000000-0000-0000-0000-000000000000`).

Таким образом, пользователь, в зависимости от его прав, может получить доступ:
* только к своим Поискам
* к всем Поискам своей организации (в том числе и системы)
* к всем Поискам система

## 1. Начать Поиск журнальных записей

**Назначение:**   Запустить новый Поиск.

При запуске Поиска устанавливаются поля принадлежности Поиска органиазции и конкретному пользователю.

**Запрос:** `/api/v2/search/new`

**Тип запроса:**  POST

**Тело запроса:**

```json
{
  "name": "re:SAR.+",
  "key": "re:SAR.+",
  "queues": [
    "3373b673-2a59-11f0-9961-02420a00017b",
    "7e8d71ff-7c39-48a7-a669-66c0d9e95bf0"
  ],
  "who":[
    "a87e5522-b4cd-11e7-abc4-cec278b6b50a"
    "90d77ba1-85f2-4dc9-8019-d4f1a00e4476"
  ],
  "start_at": 1508198400,
  "end_at": 1508284800,
  "direction": "forward",
  "attrs": {
    "format": "WMO"
  },
  "jrid": [
    "7ecd3efa-0d92-11e8-ba89-0ed5f89f718b"
  ],
  "double": [
    "cb7a5670-6fa4-11e7-907b-a6006ad3dba0"
  ],
  "cache_size": 20,
  "bt": "message",
  "attachments": true
}

```

**Возможные поля запроса:**

| **имя поля**  | **тип**    | **описание**                                                                                                            |
|---------------|------------|-------------------------------------------------------------------------------------------------------------------------|
| `name`        | `string`   | Поиск по имени файла/сокращенному заголовку метеосообщения                                                              |
| `key`         | `string`   | Поиск по ключу                                                                                                          |
| `who`         | `[]uuid`   | идентификаторы Источников роутера с которых приходят сообщения                                                          |
| `jrid`        | `[]uuid`   | идентификаторы искомых записей контекста                                                                                |
| `double`      | `[]uuid`   | идентификаторы дублей сообщений, которые необходимо найти                                                               |
| `queues`      | `[]uuid`   | идентификаторы очередей, в которые были распределены записи                                                             |
| `start_at`    | `unixtime` | начало диапазона Поиска                                                                                                 |
| `end_at`      | `unixtime` | конец диапазона Поиска                                                                                                  |
| `cache_size`  | `int`      | размер кеша для Поиска результатов. По умолчанию размер берется из глобальных настроек программы и равен 10000 записей. |
| `attrs`       | `json`     | Поиск по атрибутам журнальной записи в виде json объекта. Например: attrs: {"cccc": "uuee"}                             |
| `timeout`     | `unixtime` | время, отведённое на Поиск. двигается при получении результатов                                                         |
| `direction`   | `string`   | направление Поиска. Возможное значение `forward` и `backward` По умолчанию Поиск в прошлое (`forward`)                  |
| `bt`          | `string`   | тип тела сообщения (может быть `message` или `file`)                                                                    |
| `attachments` | `bool`     | искать только записи с вложениями                                                                                      |

**Ответ:**

```json

{
  "meta": {},
  "response": {
    "search_id": "34cf3cd4-b4de-11e7-8227-e069955b7462"
  }
}

```

**Поля ответа:**

| **имя поля** | **тип** | **описание**                    |
|--------------|---------|---------------------------------|
| `search_id`  | `uuid`  | уникальный идентификатор Поиска |

Если в Поиске не указываются параметры времени, то Поиск осуществляется на глубину 24 часа от текущей позиции времени.

Поля name, key и attrs** поддерживают работу с маской и регулярным выражением. По умолчанию работает маска. 

Чтобы указать программе использовать регулярное выражение, достаточно перед ним написать `re:`

Например, name: "re:SARA\\d{10} RUPK". 

**При работе с регулярным выражением нужно помнить об экранировании символа "/"**

Поиск автоматически заканчивается, если выполняется любое из условий:

- кеш результатов был полностью заполнен
- сработал таймаут выборки данных из кеша результатов (кеш начал "протухать")
- пользователь сам отменил Поиск

Чтобы Поиск нормально отрабатывался нужно своевременно забирать результаты Поиска из кеша.

Поиск удаляется системой в следующих случаях

- сработал таймаут получения информации по Поиску
- Поиск был уничтожен принудительно

**Принцип действия Поиска для пользователя следующий:**

1. пользователь начинает Поиск
2. периодически опрашивает информацию по Поиску для отрисовки прогресса Поиска
3. периодически забирает результаты Поиска из кеша

## 2. Принудительная остановка Поиска

**Назначение:**   для остановки ранее запущенного Поиска

**Запрос:** `/api/v2/search/:SEARCH_ID/abort`

где `SEARCH_ID` - идентификатор Поиска

**Тип запроса:** POST

**Пример:**  `/api/v2/search/34cf3cd4-b4de-11e7-8227-e069955b7462/abort`

**Возможные параметры:**

| **имя поля** | **тип** | **описание**                                 |
|--------------|---------|----------------------------------------------|
| `kill`       | `bool`  | остановить Поиск и удалить результаты Поиска |

## 3. Информация по Поиску

**Назначение:**   получить информацию по ранее запущенного Поиска.

**Запрос:** `/api/v2/search/:SEARCH_ID`

где `SEARCH_ID` - идентификатор Поиска

**Тип запроса:** GET

**Пример:**  `/api/v2/search/34cf3cd4-b4de-11e7-8227-e069955b7462`

**Ответ:**

```json

{
    "meta": {},
    "response": {
        "search": {
            "cmpid": "85697f9f-b80d-4668-8ed2-2f70ed825eee",
            "direction": "backward",
            "end_at": 1763130684,
            "find": 0,
            "in_cache": 0,
            "position": 0,
            "search_cmpid": [
              "6113408c-b4e1-11e7-b36c-e069955b7462",
              "bd8218ba-9244-11e7-abc4-cec278b6b50a"
            ],
            "search_id": "986508b5-c166-11f0-b6e3-02420a00017c",
            "search_renewal": 1763130817,
            "search_start": 1763130683,
            "start_at": 1763044284,
            "status": "done",
            "total": 24046,
            "uid": "4bcf9d6d-53b1-11ec-ab14-02420a0001b2"
        }
    }
}

```

**Поля ответа:**

| **имя поля**     | **тип**    | **описание**                                                     |
|------------------|------------|------------------------------------------------------------------|
| `cmpid`          | `uuid`     | идентификатор организации, которой принадлежит Поиск             |
| `uid`            | `uuid`     | идентификатор пользователя, которому принадлежит Поиск           |
| `search_cmpid`   | `[]uuid`   | массив идентификаторов организации, по которым выполняется Поиск |
| `search_id`      | `string`   | уникальный идентификатор Поиска                                  |
| `search_start`   | `unixtime` | начало Поиска                                                    |
| `search_renewal` | `unixtime` | время последнего запроса результатов (левая граница таймаута)    |
| `start_at`       | `unixtime` | начало временного диапазона Поиска                               |
| `end_at`         | `unixtime` | окончание временного диапазона Поиска                            |
| `position`       | `unixtime` | текущее временное положение в Поиске                             |
| `total`          | `int`      | всего записей во временном диапазоне                             |
| `find`           | `int`      | сколько всего записей было найдено                               |
| `in_cache`       | `int`      | сколько записей сейчас в кеше Поиска                             |
| `direction`      | `string`   | направление Поиска `backward`,`forward`                          |
| `status`         | `string`   | статус Поиска – `pending`, `abort`, `done`                       |

## 4. Получить результаты Поиска

**Назначение:**   получить результаты Поиска

**Запрос:** `/api/v2/search/:SEARCH_ID/results`

где `SEARCH_ID` - идентификатор Поиска

**Тип запроса:** GET

**Пример:**  `/api/v2/search/a8e8dfcd-b4e3-11e7-a03c-e069955b7462/results`

**Возможные параметры:**

| **имя поля** | **тип** | **описание**                                   |
|--------------|---------|------------------------------------------------|
| `count`      |         | кол-во возвращаемых записей. По умолчанию 500. |

**Ответ:**

```json

{
  "meta": {},
    "response": {
        "search_result": {
            "count": 100,
            "items": [
                {
                    "allowed": [
                        "00000000-0000-0000-0000-000000000000",
                        "eb905b4f-b4d3-11eb-acb6-f8b156aec8f1"
                    ],
                    "attrs": {
                        "from": "192.168.0.114:9876",
                        "link_name": "input ss2g 114 (718e95d1-b9dc-47c1-afb5-430eb47174e3) of SOCKET_SPECIAL",
                        "origin_file_name": "QYRA98 RUSM 141800.bmp",
                        "prid": "eb52a1be-84d5-11f0-a8c0-02420a00012d"
                    },
                    "bt": "file",
                    "datasets": [],
                    "file_path": "/var/communications/2025-14-11/17413152-48b5-4229-974b-bbf929f22186",
                    "first": "BM...",
                    "hash": "d87b174243aba441211c7ab6b8af8e3d",
                    "history": null,
                    "jrid": "00f0a967-c177-11f0-9994-02420a000199",
                    "metadata": {},
                    "n": 324131542,
                    "name": "QYRA98 RUSM 141800.bmp",
                    "owner": "",
                    "priority": 2,
                    "size": 457886,
                    "time": 1763137730,
                    "channel": "",
                    "topic_hierarchy": "",
                    "traceID": "xoz48uhlbql283war3fj",
                    "type": "unknown",
                    "who": "718e95d1-b9dc-47c1-afb5-430eb47174e3"
                },
                {
                    "allowed": [
                        "00000000-0000-0000-0000-000000000000",
                        "eb905b4f-b4d3-11eb-acb6-f8b156aec8f1"
                    ],
                    "attrs": {
                        "from": "192.168.0.114:9876",
                        "link_name": "input ss2g 114 (718e95d1-b9dc-47c1-afb5-430eb47174e3) of SOCKET_SPECIAL",
                        "origin_file_name": "PWCE20 RUMS 141200.bmp",
                        "prid": "eb52a1be-84d5-11f0-a8c0-02420a00012d"
                    },
                    "bt": "file",
                    "datasets": [],
                    "file_path": "/var/communications/2025-14-11/2ad481e4-6ffd-44da-bf4b-0af271c493ac",
                    "first": "BM...",
                    "hash": "c418a4be4695746906b22945bcc5466d",
                    "history": null,
                    "jrid": "00ed7ef2-c177-11f0-9994-02420a000199",
                    "double": "dd7e7954-c176-11f0-9994-02420a000199",                    
                    "metadata": {},
                    "n": 324131541,
                    "name": "PWCE20 RUMS 141200.bmp",
                    "owner": "",
                    "priority": 2,
                    "size": 353462,
                    "time": 1763137730,
                    "channel": "",
                    "topic_hierarchy": "",
                    "traceID": "1cb6od5wwso4xvoisca3",
                    "type": "unknown",
                    "who": "718e95d1-b9dc-47c1-afb5-430eb47174e3"
                },
                {
                    "allowed": [
                        "00000000-0000-0000-0000-000000000000",
                        "eb905b4f-b4d3-11eb-acb6-f8b156aec8f1"
                    ],
                    "attrs": {
                        "from": "192.168.0.114:9876",
                        "link_name": "input ss2g 114 (718e95d1-b9dc-47c1-afb5-430eb47174e3) of SOCKET_SPECIAL",
                        "origin_file_name": "PWBE40RUMS_141200.png",
                        "prid": "eb52a1be-84d5-11f0-a8c0-02420a00012d"
                    },
                    "bt": "file",
                    "datasets": [],
                    "file_path": "/var/communications/2025-14-11/4fc165e0-095e-4acc-b20e-c80f2099831f",
                    "first": "...",
                    "hash": "ad80d194cbfc6a32199b66c6b401cb98",
                    "history": null,
                    "jrid": "00e906c8-c177-11f0-9994-02420a000199",
                    "double": "dd7e7954-c176-11f0-9994-02420a000199",
                    "parent": "dd7e7954-c176-11f0-9994-02420a000199",
                    "metadata": {},
                    "n": 324131540,
                    "name": "PWBE40RUMS_141200.png",
                    "owner": "",
                    "priority": 2,
                    "size": 44974,
                    "time": 1763137730,
                    "channel": "",
                    "topic_hierarchy": "",
                    "traceID": "eaxgblcbj9n3dmhbfpgz",
                    "type": "unknown",
                    "who": "718e95d1-b9dc-47c1-afb5-430eb47174e3"
                },
                {
                    "allowed": [
                        "00000000-0000-0000-0000-000000000000",
                        "eb905b4f-b4d3-11eb-acb6-f8b156aec8f1"
                    ],
                    "attrs": {
                        "from": "192.168.0.114:9876",
                        "link_name": "input ss2g 114 (718e95d1-b9dc-47c1-afb5-430eb47174e3) of SOCKET_SPECIAL",
                        "origin_file_name": "PWCE15 RUMS 141200.bmp",
                        "prid": "eb52a1be-84d5-11f0-a8c0-02420a00012d"
                    },
                    "bt": "file",
                    "datasets": [],
                    "first": "BM...",
                    "hash": "2873e2ba0715d880679d4b8623a7c12b",
                    "parent": "dd7e7954-c176-11f0-9994-02420a000199",
                    "double": "dd7e7954-c176-11f0-9994-02420a000199",
                    "jrid": "dd7e7954-c176-11f0-9994-02420a000199",
                    "metadata": {},
                    "n": 324131523,
                    "name": "PWCE15 RUMS 141200.bmp",
                    "owner": "",
                    "priority": 2,
                    "size": 353006,
                    "time": 1763137671,
                    "channel": "",
                    "topic_hierarchy": "",
                    "traceID": "w1coslyjo21yn4s2zc56",
                    "type": "unknown",
                    "who": "718e95d1-b9dc-47c1-afb5-430eb47174e3"
                }
            ],
            "search_id": "16a13a0e-c177-11f0-b6e3-02420a00017c"
        }
    }
}

```

**Поля ответа:**

| **имя поля**     | **тип** | **описание**                    |
|------------------|---------|---------------------------------|
| `search_result`  | `json`  | объект с результатами Поиска    |
| `count`          | `int`  | количество записей в ответе идентификатор Поиска |
| `items`          | `uuid`  | уникальный идентификатор Поиска |
| `search_id`      | `uuid`  | уникальный идентификатор Поиска |

**Поля информации о журнальной записи:**

| **имя поля** | **тип** | **описание**                    |
|--------------|---------|---------------------------------|
| `jrid`              | `string`      | уникальный идентификатор журнальной записи                                            |
| `n`                 | `int64`       | сквозной номер журнальной записи                                                      |
| `name`              | `string`      | сокращенных заголовок/имя файла                                                       |
| `channel`           | `string`      | топик (канал) MQTT                                                                    |
| `topic_hierarchy`   | `string`      | ВМО топик данных                                                                      |
| `key`               | `string`      | ключ распределения                                                                    |
| `type`              | `string`      | тип метеорологического сообщения `unknown`, `WMO`, `HMS`                              |
| `hash`              | `string`      | хэш контента                                                                          |
| `trace`             | `string`      | идентификатор трассировки                                                             |
| `metadata`          | `json`        | объект с метаданными связанными с этим данными                                        |
| `metadata.urn`      | `string[255]` | уникальный идентификатор метаданных                                                   |
| `metadata.source`   | `string`      | индекс источника данных и метаданных                                                  |
| `datasets`          | `[]uuid`      | список идентификаторов Наборов данных, к которым относятся данные                     |
| `allowed`           | `[]uuid`      | список идентификаторов организаций, которым доступны данные                           |
| `attrs`             | `json`        | объект с произвольными данными                                                        |
| `time`              | `unixtime`    | время записи в хранилище                                                              |
| `size`              | `int`         | размер в байтах                                                                       |
| `who`               | `uuid`        | уникальный идентификатор интерфейса, который произвел запись                          |
| `bt`                | `string`      | тип тела сообщения (message, file)                                                    |
| `priority`          | `int`         | приоритет журнальной записи                                                           |
| `double`            | `string`      | уникальный идентификатор дублирующей журнальной записи                                |
| `first`             | `string`      | первые 255 символов от тела сообщения                                                 |
| `owner`             | `uuid`        | идентификатор организации которой принадлежит контент                                 |
| `parent`            | `uuid`        | идентификатор родительского сообщения (того, с которым связано это сообщение)         |
| `usid`              | `uuid`        | идентификатор пользователя которому принадлежит контент                               |


## 5. Получить список всех Поисков системы

**Назначение:**   получить информацию по ранее запущенным Поискам

**Запрос:** `/api/v2/search/list`

**Тип запроса:** GET

**Возможные поля запроса:**

| **имя поля** | **тип**  | **описание**                                                     |
|--------------|----------|------------------------------------------------------------------|
| `cmpid`      | `[]uuid` | список идентификаторов организаций, которым принадлежат Поиски   |
| `uid`        | `[]uuid` | список идентификаторов пользователей, которым принадлежат Поиски |

**Пример:**  `/api/v2/search/list`

**Ответ:**

```json

{
  "meta": {},
  "response": {
    "searches": {
      "count": 2,
      "items": [
        {
          "cmpid": "00000000-0000-0000-0000-000000000000",
          "uid": "00000000-0000-0000-0000-000000000000",
          "direction": "backward",
          "end_at": 1508426574,
          "find": 4,
          "in_cache": 4,
          "position": 1508375113,
          "search_cmpid": [
            "6113408c-b4e1-11e7-b36c-e069955b7462",
            "bd8218ba-9244-11e7-abc4-cec278b6b50a"
          ],
          "search_id": "6113408c-b4e1-11e7-b36c-e069955b7462",
          "start_at": 1508340174,
          "search_start": 1508340174,
          "status": "pending",
          "total": 194000
        },
        {
          "cmpid": "00000000-0000-0000-0000-000000000000",
          "uid": "00000000-0000-0000-0000-000000000000",
          "search_id": "7ab903d0-b4e6-11e7-abc4-ce6b50a",
          "total": 1000,
          "find": 10,
          "in_cache": 10,
          "status": "done"
        },
        {
          "cmpid": "00000000-0000-0000-0000-000000000000",
          "uid": "00000000-0000-0000-0000-000000000000",
          "search_id": "7ab8ff70-b4e6-11e7-abc4-cec278a",
          "total": 12223,
          "find": 2549,
          "in_cache": 1220,
          "status": "pending"
        }
      ]
    }
  }
}

```

| **имя поля** | **тип** | **описание**                    |
|--------------|---------|---------------------------------|
| `searches`  | `json`  | объект со списком Поисков |
| `count`  | `int`  | количество записей в ответе идентификатор Поиска |
| `items`  | `uuid`  | уникальный идентификатор Поиска |



